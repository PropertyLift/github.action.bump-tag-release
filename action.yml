name: Bump & Tag & Release Action
description: Common GitHub Action for bumping, tagging, and releasing

inputs:
  githubToken:
    description: 'The GitHub token to use for authentication'
    required: true
    default: ''
  projectName:
    description: 'The name of the project'
    required: true
    default: ''
  slackChannelId:
    description: 'The Slack channel to post to'
    required: true
    default: ''
  slackBotToken:
    description: 'The Slack bot token'
    required: true
    default: ''

runs:
  using: "composite"
  steps:
    - name: Configure GitHub credentials
      shell: bash -e {0}
      run: git config --global url."https://${{ inputs.githubToken }}@github.com/".insteadOf "https://github.com/"

    - name: Bump and Tag
      id: bump_and_tag
      uses: bricklanetech/action.bump-version-and-tag@v3
      with:
        prefix: 'v'

    - name: Build Changelog
      id: github_release
      uses: mikepenz/release-changelog-builder-action@v4
      env:
        GITHUB_TOKEN: ${{ inputs.githubToken }}

    - name: Create and publish release
      uses: ncipollo/release-action@v1
      with:
        body: ${{steps.github_release.outputs.changelog}}
        tag: ${{ steps.bump_and_tag.outputs.tag }}

    - name: Post to a Slack channel
      uses: slackapi/slack-github-action@v1.24.0
      with:
        channel-id: ${{ inputs.slackChannelId }}
        payload: |
          {
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*${{ inputs.projectName }} ${{ steps.bump_and_tag.outputs.tag }}* has been released :rocket:"
                }
              }
            ],
            "attachments": [
              {
                "color": "#2eb886",
                "text": ${{ toJSON(steps.github_release.outputs.changelog) }}
              }
            ]
          }
      env:
        SLACK_BOT_TOKEN: ${{ inputs.slackBotToken }}
